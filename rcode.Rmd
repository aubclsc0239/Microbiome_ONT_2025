---
title: "Microbiome"
author: "Abdulmalik_Oladipupo"
date: "2025-04-21"
output: 
   html_document:
     toc: true
---

### Install and Load all required packages
```{r setup}
# Check and install missing packages only
required_packages <- c(
    "vegan", "phyloseq", "Biostrings", "metagenomeSeq", 
    "decontam", "indicspecies", "DESeq2", "ggpubr", "tidyverse", 
    "ggplot2", "dunn.test", "writexl", "pairwiseAdonis", "remotes", "emmeans", "multcompView", 
    "cluster", "devtools", "statmod", "gtools", "BiocStyle", "DECIPHER", "phangorn", "gridExtra"
)

# Install missing packages
for (pkg in required_packages) {
    if (!requireNamespace(pkg, quietly = TRUE)) {
        cat("Installing missing package:", pkg, "\n")
        if (pkg %in% c("vegan", "phyloseq", "Biostrings", "metagenomeSeq", 
                       "decontam", "indicspecies", "DESeq2", "ggpubr", "BiocStyle", "DECIPHER", "phangorn")) {
            BiocManager::install(pkg, lib = "~/R/library")
        } else {
            install.packages(pkg, repos = "http://cran.us.r-project.org", lib = "~/R/library")
        }
    }
}

# Load libraries
library("vegan")
library("phyloseq")
library("Biostrings")
library("metagenomeSeq")
library("decontam")
library("indicspecies")
library("DESeq2")
library("ggpubr")
library("tidyverse")
library("ggplot2")
library("dunn.test")
library("writexl")
library("lme4")
library("emmeans")
library("multcomp")
library("multcompView")
library("pairwiseAdonis")
library("cluster")
library("devtools")
```

### Set up color pallet to use through this analysis F0E442
```{r}
# color blind pallet
cbbPalette <- c("#D55E00", "#8C6D3B", "#56B4E9", "#008000", "#000000", 
                "#0072B2", "#009E73", "#CC79A7", "#F1A7B6", "#1F77B4", 
                "#8C564B", "#2CA02C", "#FF7F0E", "#9467BD", "#E69F00")
```

### Load in all required formatted files from the HPC or formatted epi2me output. 

```{r set, include = FALSE}
taxa <- read.csv("R_data/Taxa_file.csv", header = TRUE, row.names = 1, na.strings = "na")
otu.table <- read.csv("R_data/OTU_table_16s.csv", na.strings = "na")
metadata <- read.csv("R_data/metadata_test.csv", na.strings = "na")
tree.read <- "R_data/tree.nwk"
fasta.read <- "R_data/fasta_file.fasta"
```

### Format all CSV input data to ensure match rows and column
```{r}
taxa$OTU <- rownames(taxa)
rownames(otu.table) <- otu.table$OTU
otu.table <- otu.table[,-1]
rownames(metadata) <- metadata$SampleID #row names must match OTU table headers
```


### Load all file into phyloseq
```{r}
phy.tax <- phyloseq::tax_table(as.matrix(taxa))
phy.OTU.table <- phyloseq::otu_table(otu.table, taxa_are_rows = TRUE)
phy.data <- phyloseq::sample_data(metadata)
phy.fasta <- Biostrings::readDNAStringSet(fasta.read, format="fasta", seek.first.rec=TRUE, use.names=TRUE)
phy.tree <- phyloseq::read_tree(tree.read)

phyloseq.data <- phyloseq(phy.tax, phy.OTU.table, phy.data, phy.fasta, phy.tree)

```
### Samples quality control and read distribution

```{r}
# filter out taxa that have non-zero abundance in less than 2 samples
ps.clean <- filter_taxa(phyloseq.data, function (x) {sum(x > 0) >= 2}, prune=TRUE)
# see read distribution from the highest to lowest
sort(sample_sums(ps.clean), decreasing = T) # read distribution
# check total reads
sum(sample_sums(ps.clean))
# chech mean read 
mean(sample_sums(ps.clean))
# median read
median(sample_sums(ps.clean))
```

## ANALYSIS AND VISUALIZATION

### Relative Abundance Plot
```{r}
# fecal samples relative amount/treatment*time
top20 <- names(sort(taxa_sums(ps.clean), decreasing=TRUE))[1:10]
ps.top20 <- transform_sample_counts(ps.clean, function(OTU) OTU/sum(OTU))
ps.top20 <- prune_taxa(top20, ps.top20)
dat.dataframe <- psmelt(ps.top20)
dat.agr <- aggregate(Abundance ~ treatment*day + Species + genus + Phylum, data = dat.dataframe, FUN = mean)
dat.agr$treatment <- factor(dat.agr$treatment, levels = c("BASAL", "YCW", "IFC4", "IFC4+YCW"))
rel_abun_treatment <-ggplot(dat.agr, aes(x = treatment, y = Abundance, fill = Species)) +
  facet_wrap(~day) +
  geom_bar(stat = "identity", position = "fill") +
  theme_classic() +
  scale_fill_manual(values=cbbPalette) +
  labs(title = "",
       x = "Treatments",
       y = "Relative Abundance (%)") +
  theme(axis.text.x = element_text(size = 12, face = "bold", vjust = 0.5, hjust=0.5),
        axis.text.y = element_text(size = 12, face = "bold"),
        axis.title.y = element_text(size = 15, face = "bold"),
        axis.title.x = element_text(size = 15, face = "bold"),
        legend.text = element_text(size = 12),    # Adjust legend text size
        legend.title = element_text(size = 15))     # Adjust legend title size 

rel_abun_treatment
```

### Alpha diversity
```{r}
# Estimate multiple richness measures at once
alpha_diversity <- estimate_richness(ps.clean, measures = c("Shannon", "InvSimpson", "Observed"))

# Add the measures to the sample data
ps.clean@sam_data$shannon <- alpha_diversity$Shannon
ps.clean@sam_data$invsimpson <- alpha_diversity$InvSimpson
ps.clean@sam_data$richness <- alpha_diversity$Observed

# Compute evenness (Shannon / log(richness))
ps.clean@sam_data$even <- ps.clean@sam_data$shannon / log(ps.clean@sam_data$richness)
```

### Prepare data for Analysis
```{r}
# extract data from phyloseq object into a dataframe
sample.df <- data.frame(ps.clean@sam_data)
# arrange order
sample.df$treatment <- factor(sample.df$treatment, levels = c("BASAL", "YCW", "IFC4", "IFC4+YCW"))
```

### Richness Visualization
```{r}
# Richness by treatment*time interaction
richness.treatment.time <- ggplot(sample.df, aes(x = treatment, y = richness, fill = treatment)) +
  geom_boxplot() +
  #geom_jitter() + 
  ylab("Richness") + 
  stat_compare_means(method = "anova") + 
  xlab("")+
  theme_bw() +
  facet_wrap(~day) +
  scale_fill_manual(values=cbbPalette) +
  theme(axis.text.x = element_text(size = 11, vjust = 0.5, hjust=0.5, face = "bold"),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 14, face = "bold"),
        axis.line = element_line(size = 0.6),
        legend.text = element_text(size = 12),    # Adjust legend text size
        legend.title = element_text(size = 16))     # Adjust legend title size

richness.treatment.time
```

#### Richness analysis
```{r}
rich.trt.time <- aov(richness ~ treatment*day, data = sample.df)
summary(rich.trt.time) #treatment=0.027, day=3.02e-05, inter=0.015

# Since there is significant interaction, split data by day
sample.df.d30 <- subset(sample.df, day == "DAY_30")
sample.df.d60 <- subset(sample.df, day == "DAY_60")
sample.df.d90 <- subset(sample.df, day == "DAY_90")

rich.30 <- lm(richness ~ treatment, data = sample.df.d30)
aov.rich.30 <- anova(rich.30) # 0.098
print(aov.rich.30)

rich.60 <- lm(richness ~ treatment, data = sample.df.d60)
aov.rich.60 <- anova(rich.60) # 0.084
print(aov.rich.60)

rich.90 <- lm(richness ~ treatment, data = sample.df.d90)
aov.rich.90 <- anova(rich.90) # 0.027
print(aov.rich.90)

lsmeans <- emmeans(rich.90, ~treatment) # fungicide effect within growthstage
Results_lsmeans <- cld(lsmeans, alpha = 0.05, reversed = TRUE, details = TRUE) # contrast with Tukey ajustment
Results_lsmeans

```

### Evenness Visualization
```{r}
# Richness by treatment*time interaction
even.treatment.time <- ggplot(sample.df, aes(x = treatment, y = even, fill = treatment)) +
  geom_boxplot() +
  #geom_jitter() + 
  ylab("Eveness") + 
  xlab("")+
  theme_bw() +
  facet_wrap(~day) +
  scale_fill_manual(values=cbbPalette) +
  theme(axis.text.x = element_text(size = 11, vjust = 0.5, hjust=0.5, face = "bold"),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 14, face = "bold"),
        axis.line = element_line(size = 0.6),
        legend.text = element_text(size = 12),    # Adjust legend text size
        legend.title = element_text(size = 16))     # Adjust legend title size

even.treatment.time
```

#### Eveness analysis
```{r}
even.trt.time <- lm(even ~ treatment*day, data = sample.df)
anova(even.trt.time) #treatment=0.088, day=0.126, inter=0.971

```

### Shannon Visualization
```{r}
# Shannon by treatment*time interaction
shannon.treatment.time <- ggplot(sample.df, aes(x = treatment, y = shannon, fill = treatment)) +
  geom_boxplot() +
  #geom_jitter() + 
  ylab("Shannon") + 
  xlab("")+
  theme_bw() +
  facet_wrap(~day) +
  scale_fill_manual(values=cbbPalette) +
  theme(axis.text.x = element_text(size = 11, vjust = 0.5, hjust=0.5, face = "bold"),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 14, face = "bold"),
        axis.line = element_line(size = 0.6),
        legend.text = element_text(size = 12),    # Adjust legend text size
        legend.title = element_text(size = 16))     # Adjust legend title size

shannon.treatment.time
```




```{r}

shan.trt.time <- aov(shannon ~ treatment*day, data = sample.df)
summary(shan.trt.time) #treatment=0.020, day=3.02e-05, inter=0.012

```
### Publication figure
```{r}
# Arrange Alpha diversity plots into a single figure
AlphaFig <- ggarrange(richness.treatment.time, 
                     even.treatment.time, 
                     shannon.treatment.time, 
                     labels = "auto", 
                     nrow = 3, ncol = 1, 
                     common.legend = TRUE)

ggsave("AlphaFig.tiff", dpi=300, width = 27, height = 23, units = "cm")

AbunFig <- ggarrange(rel_abun_treatment, nrow = 1)
ggsave("AbunFig.tiff", dpi=300, width = 32, height = 15, units = "cm")





```





































